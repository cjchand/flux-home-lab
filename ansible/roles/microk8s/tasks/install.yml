---
- name: Install snapd
  ansible.builtin.apt:
    name: snapd
    state: present

- name: Check if microk8s is installed
  ansible.builtin.command: snap list microk8s
  register: microk8s_installed
  failed_when: false
  changed_when: false

- name: Install microk8s
  community.general.snap:
    name: microk8s
    classic: yes
    channel: "{{ microk8s_channel }}"
  when: microk8s_installed.rc != 0

- name: Get current microk8s channel
  ansible.builtin.shell: snap info microk8s | grep -E '^tracking:' | awk '{print $2}'
  register: current_channel
  changed_when: false
  when: microk8s_installed.rc == 0

- name: Display current channel
  ansible.builtin.debug:
    msg: "microk8s is on channel {{ current_channel.stdout | default('not installed') }}, target is {{ microk8s_channel }}"
  when: microk8s_installed.rc == 0

- name: Wait for microk8s to be ready
  ansible.builtin.command: microk8s status --wait-ready
  changed_when: false
  retries: 5
  delay: 10
